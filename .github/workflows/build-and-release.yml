name: Build and Release SimpleModDownloader with Docker

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout repository
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Use DevkitPro Docker image
    - name: Build using DevkitPro Docker image
      uses: addnab/docker-run-action@v3
      with:
        image: devkitpro/devkitpro:latest
        options: --rm  # Clean up the container after the job
        run: |
          # Ensure xmake is installed
          curl -fsSL https://xmake.io/shget.text | bash
          export PATH=$HOME/.local/bin:$PATH
          
          # Navigate to the project directory
          cd $GITHUB_WORKSPACE
          
          # Configure and build using xmake
          xmake f -p cross --sdk=/opt/devkitpro/devkitA64
          xmake

    # Step 3: Archive the output
    - name: Archive output
      run: |
        mkdir -p output
        mv ./build/cross/aarch64/release/SimpleModDownloader.nro output/
      # Replace the path above with the actual output path for your .nro file

    # Step 4: Create a GitHub Release
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }} # Automatically generate version numbers based on workflow run
        release_name: Release v${{ github.run_number }}
        body: |
          This is an automated release generated by the Build and Release workflow.
        draft: false # Set to true if you want the release to be a draft
        prerelease: false # Set to true for pre-releases

    # Step 5: Upload Release Asset
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: output/SimpleModDownloader.nro
        asset_name: SimpleModDownloader.nro
        asset_content_type: application/octet-stream